<template>
  <div class="skeleton">
    <SidebarLayout
      v-if="leftVisible"
      class="left"
      :class="sidebarClasses"
      :widgetOptions="sidebarWidgetOptions"
      @changeWidget="(widget) => addWidget('left', widget)"
      @removeWidget="(index) => removeWidget('left', index)"
      @editToggle="editing = !editing"
      :widgets="leftWidgets"
      :editing="editing"
    >
      <div slot="button-container" class="button-container">
        <button class="toggle-open" v-if="leftOpen" @click="onLeftToggle">
          <Icon name="arrow-left" />
        </button>
        <button class="toggle-open" v-else @click="onLeftToggle">
          <Icon name="arrow-right" />
        </button>
      </div>
    </SidebarLayout>

    <MainLayout
      @changeWidget="changeWidget"
      @editToggle="editing = !editing"
      :editing="editing"
      :widget="mainWidget"
      :widgetOptions="mainWidgetOptions"
      :isEditable="isEditable"
    />

    <SidebarLayout
      v-if="rightVisible"
      class="right"
      :class="sidebarClasses"
      :widgetOptions="sidebarWidgetOptions"
      @changeWidget="(widget) => addWidget('right', widget)"
      @removeWidget="(index) => removeWidget('right', index)"
      @editToggle="editing = !editing"
      :widgets="rightWidgets"
      :editing="editing"
    >
      <div slot="button-container" class="button-container">
        <button class="toggle-open" v-if="rightOpen" @click="onRightToggle">
          <Icon name="arrow-right" />
        </button>
        <button class="toggle-open" v-else @click="onRightToggle">
          <Icon name="arrow-left" />
        </button>
      </div>
    </SidebarLayout>
  </div>
</template>

<script>
  import MainLayout from './main/MainLayout.vue';
  import SidebarLayout from './sidebar/SidebarLayout.vue';
  import {
    MODULE_NS,
    TOGGLE_LEFT_SIDEBAR,
    TOGGLE_RIGHT_SIDEBAR,
    ADD_LEFT_WIDGET,
    ADD_RIGHT_WIDGET,
    REMOVE_LEFT_WIDGET,
    REMOVE_RIGHT_WIDGET,
    CHANGE_MAIN_WIDGET,
  } from '@scaife-viewer/store';

  const removeActions = {
    left: REMOVE_LEFT_WIDGET,
    right: REMOVE_RIGHT_WIDGET,
  };

  export default {
    components: { MainLayout, SidebarLayout },
    data() {
      return {
        editing: false,
        isEditable: true,
      };
    },
    methods: {
      onLeftToggle() {
        this.$emit('leftToggle');
        this.$store.dispatch(`${MODULE_NS}/${TOGGLE_LEFT_SIDEBAR}`);
      },
      onRightToggle() {
        this.$emit('rightToggle');
        this.$store.dispatch(`${MODULE_NS}/${TOGGLE_RIGHT_SIDEBAR}`);
      },
      addWidget(name, widget) {
        this.$emit('addWidget', name, widget);
        switch (name) {
          case 'left':
            this.$store.dispatch(`${MODULE_NS}/${ADD_LEFT_WIDGET}`, { widget });
            break;
          case 'right':
            this.$store.dispatch(`${MODULE_NS}/${ADD_RIGHT_WIDGET}`, { widget });
            break;
        }
      },
      changeWidget(mainWidget) {
        this.$emit('changeWidget', mainWidget);
        this.$store.dispatch(`${MODULE_NS}/${CHANGE_MAIN_WIDGET}`, {
          widget: mainWidget,
        });
      },
      removeWidget(name, index) {
        this.$emit('removeWidget', name, index);
        const action = removeActions[name];
        if (action) {
          this.$store.dispatch(action, { index });
        }
      },
    },
    computed: {
      leftOpen() {
        return this.$store.state[MODULE_NS].leftOpen;
      },
      rightOpen() {
        return this.$store.state[MODULE_NS].rightOpen;
      },
      widgets() {
        return this.$store.state[MODULE_NS].widgets;
      },
      scaifeSkeleton() {
        return this.$scaife.skeleton;
      },
      leftWidgets() {
        return this.widgets.left.map(
          (name) => this.$scaife.skeleton.widgets[name],
        );
      },
      rightWidgets() {
        return this.widgets.right.map(
          (name) => this.$scaife.skeleton.widgets[name],
        );
      },
      mainWidget() {
        return (
          this.widgets.mainWidget &&
          this.$scaife.skeleton.widgets[this.widgets.mainWidget]
        );
      },
      sidebarClasses() {
        return [
          this.leftOpen ? 'sidebar-left--open' : 'sidebar-left--closed',
          this.rightOpen ? 'sidebar-right--open' : 'sidebar-right--closed',
        ];
      },
      mainWidgetOptions() {
        return this.$scaife.skeleton.widgetOptions(
          'main',
          this.mainWidget,
          this.leftWidgets,
          this.rightWidgets,
        );
      },
      sidebarWidgetOptions() {
        return this.$scaife.skeleton.widgetOptions(
          'sidebar',
          this.mainWidget,
          this.leftWidgets,
          this.rightWidgets,
        );
      },
    },
  };
</script>

<style lang="scss" src="./skeleton.scss"></style>
